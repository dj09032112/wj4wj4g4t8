/**
 * ÂúãÈöõÂåñ (i18n) Á≥ªÁµ±
 * Ëá™ÂãïÊ™¢Ê∏¨ÁÄèË¶ΩÂô®Ë™ûË®Ä‰∏¶ËºâÂÖ•Â∞çÊáâÁöÑË™ûË®ÄÊ™îÊ°à
 */

class I18n {
    constructor() {
        this.currentLanguage = 'en'; // È†êË®≠Ë™ûË®Ä
        this.translations = {}; // ÁøªË≠ØÂÖßÂÆπ
        this.languageMap = {
            'zh': 'zh',
            'zh-TW': 'zh',
            'zh-HK': 'zh',
            'zh-CN': 'zh',
            'en': 'en',
            'en-US': 'en',
            'en-GB': 'en'
        };
        
        this.init();
    }

    /**
     * ÂàùÂßãÂåñi18nÁ≥ªÁµ±
     */
    async init() {
        try {
            // Ê™¢Ê∏¨ÁÄèË¶ΩÂô®Ë™ûË®Ä
            this.detectLanguage();
            
            // ËºâÂÖ•Ë™ûË®ÄÊ™îÊ°à
            await this.loadLanguageFile();
            
            // Êõ¥Êñ∞È†ÅÈù¢ÊñáÂ≠ó
            this.updatePageText();
            
            console.log(`üåç i18nÁ≥ªÁµ±Â∑≤ÂàùÂßãÂåñÔºåÁï∂ÂâçË™ûË®Ä: ${this.currentLanguage}`);
        } catch (error) {
            console.error('‚ùå i18nÁ≥ªÁµ±ÂàùÂßãÂåñÂ§±Êïó:', error);
            // ‰ΩøÁî®È†êË®≠Ëã±Êñá
            this.currentLanguage = 'en';
            await this.loadLanguageFile();
        }
    }

    /**
     * Ê™¢Ê∏¨ÁÄèË¶ΩÂô®Ë™ûË®Ä
     */
    detectLanguage() {
        // ÂÑ™ÂÖà‰ΩøÁî® localStorage ‰∏≠ÂÑ≤Â≠òÁöÑË™ûË®ÄË®≠ÂÆö
        const savedLanguage = localStorage.getItem('preferred_language');
        if (savedLanguage && this.languageMap[savedLanguage]) {
            this.currentLanguage = this.languageMap[savedLanguage];
            return;
        }

        // Ê™¢Ê∏¨ÁÄèË¶ΩÂô®Ë™ûË®Ä
        const browserLanguages = navigator.languages || [navigator.language];
        
        for (const lang of browserLanguages) {
            const mappedLang = this.languageMap[lang];
            if (mappedLang) {
                this.currentLanguage = mappedLang;
                // ÂÑ≤Â≠òË™ûË®ÄÂÅèÂ•Ω
                localStorage.setItem('preferred_language', lang);
                break;
            }
        }
    }

    /**
     * ËºâÂÖ•Ë™ûË®ÄÊ™îÊ°à
     */
    async loadLanguageFile() {
        try {
            const response = await fetch(`lang/${this.currentLanguage}.json`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            this.translations = await response.json();
        } catch (error) {
            console.error(`‚ùå ËºâÂÖ•Ë™ûË®ÄÊ™îÊ°àÂ§±Êïó (${this.currentLanguage}):`, error);
            // Â¶ÇÊûúËºâÂÖ•Â§±ÊïóÔºåÂòóË©¶ËºâÂÖ•Ëã±Êñá‰ΩúÁÇ∫ÂÇôÁî®
            if (this.currentLanguage !== 'en') {
                this.currentLanguage = 'en';
                await this.loadLanguageFile();
            } else {
                throw error;
            }
        }
    }

    /**
     * ÂèñÂæóÁøªË≠ØÊñáÂ≠ó
     * @param {string} key - ÁøªË≠ØÈçµÂÄº (‰æãÂ¶Ç: "meta.title")
     * @param {Object} params - ÂèØÈÅ∏ÁöÑÂèÉÊï∏ÊõøÊèõ
     * @returns {string} ÁøªË≠ØÂæåÁöÑÊñáÂ≠ó
     */
    t(key, params = {}) {
        try {
            // ‰ΩøÁî®ÈªûË®òÊ≥ïÂèñÂæóÂ∑¢ÁãÄÁâ©‰ª∂ÂÄº
            const keys = key.split('.');
            let value = this.translations;
            
            for (const k of keys) {
                if (value && typeof value === 'object' && k in value) {
                    value = value[k];
                } else {
                    console.warn(`‚ö†Ô∏è Êâæ‰∏çÂà∞ÁøªË≠ØÈçµÂÄº: ${key}`);
                    return key; // ÂõûÂÇ≥ÂéüÂßãÈçµÂÄº
                }
            }

            if (typeof value !== 'string') {
                console.warn(`‚ö†Ô∏è ÁøªË≠ØÂÄº‰∏çÊòØÂ≠ó‰∏≤: ${key}`);
                return key;
            }

            // ÂèÉÊï∏ÊõøÊèõ
            let result = value;
            for (const [param, replacement] of Object.entries(params)) {
                result = result.replace(new RegExp(`\\{${param}\\}`, 'g'), replacement);
            }

            return result;
        } catch (error) {
            console.error(`‚ùå ÁøªË≠ØËôïÁêÜÂ§±Êïó (${key}):`, error);
            return key;
        }
    }

    /**
     * Êõ¥Êñ∞È†ÅÈù¢ÊñáÂ≠ó
     */
    updatePageText() {
        // Êõ¥Êñ∞ meta Ê®ôÁ±§
        this.updateMetaTags();
        
        // Êõ¥Êñ∞È†ÅÈù¢Ê®ôÈ°å
        this.updatePageTitle();
        
        // Êõ¥Êñ∞UIÊåâÈàïÊñáÂ≠ó
        this.updateUIElements();
        
        // Êõ¥Êñ∞ÈôÄËû∫ÂÑÄÊ¨äÈôêÂ∞çË©±Ê°Ü
        this.updateGyroDialog();
        
        // Êõ¥Êñ∞ÊèêÁ§∫ÊñáÂ≠ó
        this.updateHintText();
    }

    /**
     * Êõ¥Êñ∞ meta Ê®ôÁ±§
     */
    updateMetaTags() {
        // Êõ¥Êñ∞ Open Graph Ê®ôÁ±§
        const ogTitle = document.querySelector('meta[property="og:title"]');
        const ogDescription = document.querySelector('meta[property="og:description"]');
        const ogUrl = document.querySelector('meta[property="og:url"]');
        
        if (ogTitle) ogTitle.setAttribute('content', this.t('meta.og_title'));
        if (ogDescription) ogDescription.setAttribute('content', this.t('meta.og_description'));
        if (ogUrl) ogUrl.setAttribute('content', this.t('meta.og_url'));
        
        // Êõ¥Êñ∞ Twitter Ê®ôÁ±§
        const twitterTitle = document.querySelector('meta[name="twitter:title"]');
        const twitterDescription = document.querySelector('meta[name="twitter:description"]');
        
        if (twitterTitle) twitterTitle.setAttribute('content', this.t('meta.og_title'));
        if (twitterDescription) twitterDescription.setAttribute('content', this.t('meta.og_description'));
    }

    /**
     * Êõ¥Êñ∞È†ÅÈù¢Ê®ôÈ°å
     */
    updatePageTitle() {
        document.title = this.t('meta.title');
    }



    /**
     * Êõ¥Êñ∞UIÂÖÉÁ¥†ÊñáÂ≠ó
     */
    updateUIElements() {
        // Êõ¥Êñ∞ÊåâÈàïÁöÑ aria-label
        const backButton = document.getElementById('back-button');
        if (backButton) {
            backButton.setAttribute('aria-label', this.t('ui.back'));
        }

        const fullscreenButton = document.getElementById('fullscreen-button');
        if (fullscreenButton) {
            fullscreenButton.setAttribute('aria-label', this.t('ui.fullscreen'));
        }

        const resetViewButton = document.getElementById('reset-view-button');
        if (resetViewButton) {
            resetViewButton.setAttribute('aria-label', this.t('ui.reset_view'));
        }

        // Êõ¥Êñ∞ÊèêÁ§∫Â∞çË©±Ê°ÜÊñáÂ≠ó
        this.updateTooltipText();
    }

    /**
     * Êõ¥Êñ∞ÊèêÁ§∫Â∞çË©±Ê°ÜÊñáÂ≠ó
     */
    updateTooltipText() {
        const fullscreenTooltip = document.getElementById('fullscreen-tooltip');
        const resetViewTooltip = document.getElementById('reset-view-tooltip');

        if (fullscreenTooltip) {
            const title = fullscreenTooltip.querySelector('.tooltip-title');
            const subtitle = fullscreenTooltip.querySelector('.tooltip-subtitle');
            
            if (title) {
                title.textContent = this.t('ui.fullscreen');
                title.setAttribute('lang', this.currentLanguage);
            }
            if (subtitle) {
                subtitle.textContent = this.t('ui.click_to_close');
                subtitle.setAttribute('lang', this.currentLanguage);
            }
        }

        if (resetViewTooltip) {
            const title = resetViewTooltip.querySelector('.tooltip-title');
            const subtitle = resetViewTooltip.querySelector('.tooltip-subtitle');
            
            if (title) {
                title.textContent = this.t('ui.reset_view');
                title.setAttribute('lang', this.currentLanguage);
            }
            if (subtitle) {
                subtitle.textContent = this.t('ui.click_to_close');
                subtitle.setAttribute('lang', this.currentLanguage);
            }
        }
        
        // üåç Ë™ûË®ÄÂàáÊèõÂæåÈáçÊñ∞Ë®àÁÆóÂ∞çË©±Ê°Ü‰ΩçÁΩÆ
        this.repositionTooltips();
    }
    
    /**
     * ÈáçÊñ∞Ë®àÁÆóÂ∞çË©±Ê°Ü‰ΩçÁΩÆ
     */
    repositionTooltips() {
        // Ê™¢Êü•ÊòØÂê¶ÊúâÂÖ®ÂüüÁöÑ ParallaxViewer ÂØ¶‰æã
        if (window.parallaxViewerInstance && window.parallaxViewerInstance.updateTooltipPositions) {
            // Âª∂ÈÅ≤Âü∑Ë°åÔºåÁ¢∫‰øùDOMÊõ¥Êñ∞ÂÆåÊàê
            setTimeout(() => {
                window.parallaxViewerInstance.updateTooltipPositions();
            }, 50);
        }
    }

    /**
     * Êõ¥Êñ∞ÈôÄËû∫ÂÑÄÊ¨äÈôêÂ∞çË©±Ê°Ü
     */
    updateGyroDialog() {
        const gyroTitle = document.querySelector('.gyro-permission-title');
        const gyroDesc = document.querySelector('.gyro-permission-desc');
        const allowBtn = document.querySelector('.gyro-permission-btn.primary');
        const denyBtn = document.querySelector('.gyro-permission-btn:not(.primary)');

        if (gyroTitle) gyroTitle.textContent = this.t('gyro.title');
        if (gyroDesc) gyroDesc.textContent = this.t('gyro.description');
        if (allowBtn) allowBtn.textContent = this.t('gyro.allow');
        if (denyBtn) denyBtn.textContent = this.t('gyro.deny');
    }

    /**
     * Êõ¥Êñ∞ÊèêÁ§∫ÊñáÂ≠ó
     */
    updateHintText() {
        const mainHint = document.querySelector('.main-hint');
        const detailHint = document.querySelector('.detail-hint');
        const landscapeHint = document.querySelector('#landscape-hint .hint-content');
        
        if (mainHint) {
            const mainKey = mainHint.getAttribute('data-i18n');
            if (mainKey) {
                mainHint.textContent = this.t(mainKey);
                mainHint.setAttribute('lang', this.currentLanguage);
            }
        }
        
        if (detailHint) {
            const detailKey = detailHint.getAttribute('data-i18n');
            if (detailKey) {
                detailHint.textContent = this.t(detailKey);
                detailHint.setAttribute('lang', this.currentLanguage);
            }
        }
        
        if (landscapeHint) {
            const landscapeKey = landscapeHint.getAttribute('data-i18n');
            if (landscapeKey) {
                landscapeHint.textContent = this.t(landscapeKey);
                landscapeHint.setAttribute('lang', this.currentLanguage);
            }
        }
    }

    /**
     * ÂàáÊèõË™ûË®Ä
     * @param {string} language - Ë™ûË®Ä‰ª£Á¢º ('en' Êàñ 'zh')
     */
    async switchLanguage(language) {
        if (!this.languageMap[language]) {
            console.error(`‚ùå ‰∏çÊîØÊè¥ÁöÑË™ûË®Ä: ${language}`);
            return;
        }

        this.currentLanguage = this.languageMap[language];
        localStorage.setItem('preferred_language', language);
        
        await this.loadLanguageFile();
        this.updatePageText();
        
        console.log(`üåç Ë™ûË®ÄÂ∑≤ÂàáÊèõÁÇ∫: ${this.currentLanguage}`);
    }

    /**
     * ÂèñÂæóÁï∂ÂâçË™ûË®Ä
     * @returns {string} Áï∂ÂâçË™ûË®Ä‰ª£Á¢º
     */
    getCurrentLanguage() {
        return this.currentLanguage;
    }

    /**
     * ÂèñÂæóÊîØÊè¥ÁöÑË™ûË®ÄÂàóË°®
     * @returns {Array} ÊîØÊè¥ÁöÑË™ûË®ÄÂàóË°®
     */
    getSupportedLanguages() {
        return Object.keys(this.languageMap);
    }
}

// ÂÖ®Âüü i18n ÂØ¶‰æã
let i18nInstance = null;

// ÂàùÂßãÂåñÂáΩÊï∏
async function initI18n() {
    if (!i18nInstance) {
        i18nInstance = new I18n();
    }
    return i18nInstance;
}

// Á∞°ÂåñÁöÑÁøªË≠ØÂáΩÊï∏
function t(key, params = {}) {
    if (i18nInstance) {
        return i18nInstance.t(key, params);
    }
    return key;
}

// Ë™ûË®ÄÂàáÊèõÂáΩÊï∏
async function switchLanguage(language) {
    if (i18nInstance) {
        await i18nInstance.switchLanguage(language);
    }
}

// üåç ÂÖ®Âüü i18nTest Áâ©‰ª∂ - Áî®ÊñºÁÄèË¶ΩÂô®ÊéßÂà∂Âè∞Ê∏¨Ë©¶
window.i18nTest = {
    /**
     * ÂàáÊèõÂà∞Ëã±Êñá
     */
    en: async function() {
        console.log('üåç ÂàáÊèõÂà∞Ëã±Êñá...');
        await switchLanguage('en');
        console.log('‚úÖ Â∑≤ÂàáÊèõÂà∞Ëã±Êñá');
    },
    
    /**
     * ÂàáÊèõÂà∞ÁπÅÈ´î‰∏≠Êñá
     */
    zh: async function() {
        console.log('üåç ÂàáÊèõÂà∞ÁπÅÈ´î‰∏≠Êñá...');
        await switchLanguage('zh-TW');
        console.log('‚úÖ Â∑≤ÂàáÊèõÂà∞ÁπÅÈ´î‰∏≠Êñá');
    },
    
    /**
     * ÂèñÂæóÁï∂ÂâçË™ûË®Ä
     */
    getCurrentLanguage: function() {
        if (i18nInstance) {
            return i18nInstance.getCurrentLanguage();
        }
        return 'unknown';
    },
    
    /**
     * ÂèñÂæóÊîØÊè¥ÁöÑË™ûË®ÄÂàóË°®
     */
    getSupportedLanguages: function() {
        if (i18nInstance) {
            return i18nInstance.getSupportedLanguages();
        }
        return [];
    },
    
    /**
     * ÁøªË≠ØÊñáÂ≠ó
     */
    t: function(key, params = {}) {
        return t(key, params);
    }
};

// Âú®ÊéßÂà∂Âè∞È°ØÁ§∫‰ΩøÁî®Ë™™Êòé
console.log('üåç i18nTest Â∑≤ËºâÂÖ•ÔºÅ‰ΩøÁî®ÊñπÂºèÔºö');
console.log('  i18nTest.en()           // ÂàáÊèõÂà∞Ëã±Êñá');
console.log('  i18nTest.zh()           // ÂàáÊèõÂà∞ÁπÅÈ´î‰∏≠Êñá');
console.log('  i18nTest.getCurrentLanguage()  // ÂèñÂæóÁï∂ÂâçË™ûË®Ä');
console.log('  i18nTest.t("key")       // ÁøªË≠ØÊñáÂ≠ó'); 